services:
  # Backtrader Trading Engine (commented out - not needed for V2 optimization)
  # backtrader:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: backtrader-engine
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./algorithms:/app/algorithms
  #     - ./strategies:/app/strategies
  #     - ./config:/app/config
  #     - ./data:/app/data
  #     - ./results:/app/results
  #     - ./logs:/app/logs
  #     - ./scripts:/app/scripts
  #     - ./utils:/app/utils
  #     - ./.env:/app/.env
  #   working_dir: /app
  #   environment:
  #     - PYTHONUNBUFFERED=1
  #     - BACKTRADER_ENGINE_PATH=/app
  #     - PYTHONPATH=/app
  #     - MLFLOW_TRACKING_URI=http://mlflow:5000
  #     - IB_HOST=${IB_HOST}
  #     - FINNHUB_API_KEY=${FINNHUB_API_KEY}
  #   networks:
  #     - trading-network
  #   depends_on:
  #     - ib-gateway
  #     - sqlite
  #     - mlflow
  #     - postgres
  #   restart: unless-stopped
  #   command: ["tail", "-f", "/dev/null"]

  # Interactive Brokers Gateway (commented out - not needed for V2 optimization)
  # ib-gateway:
  #   image: ghcr.io/extrange/ibkr:stable
  #   container_name: ib-gateway
  #   ulimits:
  #     nofile: 10000  # Prevent FD table errors
  #   env_file:
  #     - .env
  #   environment:
  #     - USERNAME=${IB_USERNAME}
  #     - PASSWORD=${IB_PASSWORD}
  #     - GATEWAY_OR_TWS=gateway
  #     - TWOFA_TIMEOUT_ACTION=restart
  #     - IBC_TradingMode=${IB_TRADING_MODE:-paper}
  #     - IBC_ReadOnlyApi=no
  #     - ReadOnlyApi=no
  #     - IBC_AcceptNonBrokerageAccountWarning=yes
  #     - IBC_AcceptIncomingConnectionAction=accept
  #     - IBC_TrustedTwsApiClientIPs=172.25.0.0/16
  #   ports:
  #     - "6080:6080"  # noVNC browser access
  #     - "8888:8888"  # API access (unified port for paper/live) - accessible from Docker network
  #   networks:
  #     - trading-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "nc", "-z", "localhost", "8888"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # PostgreSQL Database (MLflow Backend + Optuna Storage + Trading Framework)
  postgres:
    image: postgres:16-alpine
    container_name: mlflow-postgres
    environment:
      POSTGRES_DB: trading
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow_secure_password
    ports:
      - "5432:5432"  # Expose to host for trading framework scripts
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - trading-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mlflow"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Queue for Parallel Backtesting
  redis:
    image: redis:7-alpine
    container_name: redis-queue
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - trading-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # FastAPI Backend Service (Epic 25)
  fastapi-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: fastapi-backend
    ports:
      - "8230:8230"  # FastAPI default port
    volumes:
      - ./backend:/app/backend:ro
      - ./configs:/app/configs:ro
      - ./strategies:/app/strategies:ro
      - ./scripts:/app/scripts:ro
      - ./utils:/app/utils:ro
      - ./data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=8230
      - DATABASE_URL=postgresql://mlflow:mlflow_secure_password@postgres:5432/trading
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - trading-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8230/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # LEAN Optimizer Service
  lean-optimizer:
    build:
      context: .
      dockerfile: Dockerfile.optimizer
    container_name: lean-optimizer
    working_dir: /home/vbhatnagar/code/ai_trading_backtesting
    volumes:
      # Mount at absolute host paths for Docker-in-Docker compatibility
      - /home/vbhatnagar/code/ai_trading_backtesting/lean_projects:/home/vbhatnagar/code/ai_trading_backtesting/lean_projects
      - /home/vbhatnagar/code/ai_trading_backtesting/scripts:/home/vbhatnagar/code/ai_trading_backtesting/scripts
      - /home/vbhatnagar/code/ai_trading_backtesting/configs:/home/vbhatnagar/code/ai_trading_backtesting/configs
      - /home/vbhatnagar/code/ai_trading_backtesting/data:/home/vbhatnagar/code/ai_trading_backtesting/data
      - /home/vbhatnagar/code/ai_trading_backtesting/results:/home/vbhatnagar/code/ai_trading_backtesting/results
      - /home/vbhatnagar/code/ai_trading_backtesting/.env:/home/vbhatnagar/code/ai_trading_backtesting/.env
      - /var/run/docker.sock:/var/run/docker.sock  # Docker-in-Docker access
      - /home/vbhatnagar/.lean:/root/.lean  # LEAN CLI config
      - /tmp:/tmp  # Share host /tmp for LEAN CLI temp files
    environment:
      - PYTHONUNBUFFERED=1
      - POSTGRES_DB=trading
      - POSTGRES_USER=mlflow
      - POSTGRES_PASSWORD=mlflow_secure_password
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    networks:
      - trading-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"  # Run on demand only
    command: ["tail", "-f", "/dev/null"]

networks:
  trading-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
